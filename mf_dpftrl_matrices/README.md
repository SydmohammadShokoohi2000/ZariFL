# MF-DP-FTRL for Gboard

TODO: b/259699460 - Add a self-contained notebook for privacy accounting.

This folder contains the matrices generated by
[(Amplified) Banded Matrix Factorization: A unified approach to private training](https://arxiv.org/abs/2306.08153)
for two settings

-   Total rounds 2000 and band size of 400
-   Total rounds 2000 and band size of 1000

These pre-generated matrices can be used in the matrix factorization
differentially private follow the regularized ladder (MF-DP-FTRL) algorithm to
achieve strong privacy-utility-computation trade-offs in both centralized and
federated learning. The matrices can be loaded by the following code snippet.

```
import tensorflow as tf

B_MATRIX_STRING = 'b_matrix_tensor_pb'
C_MATRIX_STRING = 'c_matrix_tensor_pb'
LR_VECTOR_STRING = 'lr_vector_tensor_pb'

def load_factorized_matrices(
    path: str,
) -> Tuple[tf.Tensor, tf.Tensor, Optional[tf.Tensor]]:
  """Loads B, C, and possibly a vector of learning rates.

  The factorization is generated by following "(Amplified) Banded Matrix
  Factorization: A unified approach to private training"
  https://arxiv.org/abs/2306.08153

  Args:
    path: A directory to read from.

  Returns:
    A tuple (b_matrix, c_matrix, learning_rate_vector).
  """
  if not (tf.io.gfile.exists(path) and tf.io.gfile.isdir(path)):
    raise ValueError(
        f'Matrix factorization directory {path} does not exist. '
        'Check flag values or ask for the files to be '
        'generated.'
    )
  b_matrix = tf.io.parse_tensor(
      tf.io.read_file(_join_path(path, B_MATRIX_STRING)), tf.float64
  )
  c_matrix = tf.io.parse_tensor(
      tf.io.read_file(_join_path(path, C_MATRIX_STRING)), tf.float64
  )
  lr_file = _join_path(path, LR_VECTOR_STRING)
  lr_tensor = None
  if tf.io.gfile.exists(lr_file):
    lr_tensor = tf.io.parse_tensor(
        tf.io.read_file(_join_path(path, LR_VECTOR_STRING)), tf.float64
    )
  return b_matrix, c_matrix, lr_tensor

B1, C1, L = load_factorized_matrices('bands400_rounds2000')
B2, C2, _ = load_factorized_matrices('bands1000_rounds2000')
```
